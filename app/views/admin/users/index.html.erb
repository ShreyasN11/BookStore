<div class="max-w-6xl mx-auto px-4 py-12">
  
  <!-- Header Section -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-10">
    <div>
      <h1 class="text-3xl font-serif font-medium text-stone-900">User Directory</h1>
      <p class="text-stone-500 mt-1">Manage account permissions and member access levels.</p>
    </div>
    
    <div class="bg-white border border-stone-200 px-6 py-3 rounded-2xl shadow-sm">
      <span class="text-xs font-bold text-stone-400 uppercase tracking-widest block">Total Members</span>
      <span class="text-xl font-serif font-bold text-stone-900"><%= @users.count %></span>
    </div>
  </div>

  <div class="bg-indigo-50 border border-indigo-100 rounded-[2rem] p-8 mb-8">
    <h3 class="text-indigo-900 font-serif text-xl mb-4 text-center">Quick Impersonation</h3>
    
    <%= form_with url: admin_impersonations_path, method: :post, class: "max-w-md mx-auto flex gap-3" do |f| %>
      <div class="flex-1">
        <%= f.select :user_id, 
            @users.map { |u| ["#{u.username || 'No Username'} (#{u.email})", u.id] }, 
            { include_blank: "Search for a user..." }, 
            { id: "impersonate-select", class: "w-full" } %>
      </div>
      <%= f.submit "Impersonate", class: "bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-indigo-700 cursor-pointer transition shadow-md shadow-indigo-200" %>
    <% end %>
  </div>

  <!-- TomSelect JS Initialization -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  <script>
    document.addEventListener("turbo:load", function() {
      const el = document.getElementById('impersonate-select');
      if (el && !el.tomselect) {
        new TomSelect(el, {
          create: false,
          sortField: { field: "text", direction: "asc" }
        });
      }
    });
  </script>
  <div class="bg-white border border-stone-200 rounded-[2rem] shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-stone-50/50 border-b border-stone-100">
            <th class="px-8 py-4 text-[11px] font-bold text-stone-400 uppercase tracking-widest">User Details</th>
            <th class="px-8 py-4 text-[11px] font-bold text-stone-400 uppercase tracking-widest">Role</th>
            <th class="px-8 py-4 text-[11px] font-bold text-stone-400 uppercase tracking-widest">Joined</th>
            <th class="px-8 py-4 text-[11px] font-bold text-stone-400 uppercase tracking-widest text-right">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-stone-100">
          <% @users.each do |user| %>
            <tr class="group hover:bg-stone-50/30 transition-colors">
              
              <!-- Details -->
              <td class="px-8 py-5">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 font-bold text-xs border border-indigo-100">
                    <%= user.email[0..1].upcase %>
                  </div>
                  <div>
                    <p class="font-bold text-stone-900"><%= user.name.presence || "No Name Set" %></p>
                    <p class="text-xs text-stone-500"><%= user.email %></p>
                  </div>
                </div>
              </td>

              <!-- Role Badge -->
              <td class="px-8 py-5">
                <% role_classes = case user.role
                   when 'super_admin' then 'bg-indigo-50 text-indigo-700 border-indigo-100'
                   when 'admin' then 'bg-amber-50 text-amber-700 border-amber-100'
                   when 'stockmanager' then 'bg-emerald-50 text-emerald-700 border-emerald-100'
                   else 'bg-stone-100 text-stone-600 border-stone-200'
                   end %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase border <%= role_classes %>">
                  <%= user.role.titleize %>
                </span>
              </td>

              <!-- Date -->
              <td class="px-8 py-5 text-sm text-stone-500">
                <%= user.created_at.strftime("%b %d, %Y") %>
              </td>

              <!-- Actions -->
              <td class="px-8 py-5 text-right">
                <div class="flex justify-end items-center gap-4">
                  <%= link_to admin_user_path(user), class: "text-stone-400 hover:text-indigo-600 transition", title: "View Profile" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  <% end %>

                  <%= link_to edit_admin_user_path(user), class: "text-stone-400 hover:text-amber-600 transition", title: "Edit User" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-5M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z" />
                    </svg>
                  <% end %>

                  <% unless user == current_user %>
                    <%= button_to admin_user_path(user), method: :delete, data: { turbo_confirm: "Are you sure you want to delete #{user.email}?" }, class: "text-stone-400 hover:text-red-600 transition cursor-pointer", title: "Delete User" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    <% end %>
                  <% end %>
                </div>
              </td>

            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>